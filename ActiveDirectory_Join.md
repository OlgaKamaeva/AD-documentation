## Ввод машины в домен
Ввод машины в домен — это процесс, в результате которого компьютер становится частью инфраструктуры Active Directory (AD) или другого домена, управляемого централизованной службой каталогов. Это действие связывает компьютер с доменом и наделяет его рядом характеристик и возможностей, таких как централизованная аутентификация, авторизация и управление настройками.

Для того, чтобы машина стала частью домена, необходимо выполнение следующих действий:
1. На контроллере домена - изменение LDAP-базы домена;
2. На клиенте (машина, которую необходимо ввести в домен) - настройка сети и системных конфигураций.

### На контроллере домена
Ключевым моментом на контроллере домена  является создание  машинной учетной записи, к которой впоследствии будет привязана машина. 
Происходит создание объекта computer с уникальным именем машины в формате MACHINE$. Учетная запись привязывается к контейнеру или определенной организационной единице (OU) в базе LDAP, что позволяет контролировать доступ машины в домен и устанавливать необходимые групповые политики. По умолчанию учетные записи компьютеров создаются в контейнере Computers.

#### Примечания
**Длинные имена машин в домене**

Рекомендации (для имен хостов, больше 15 символов)

**Для клиентов и серверов на базе ALT:**
* Хосту задаётся два имени: длинное (dnsHostname) и короткое (sAMAccountName, NetBIOS Name).
* Длинное имя должно совпадать с именем хоста (hostname).
* При введении хоста в домен оба имени нужно указывать явно.
* Оба имени должны быть уникальными.
* Для корректной работы службы SSSD в параметре настройки ad_hostname необходимо задавать короткое имя хоста.
* Обновление DNS записей с помощью SSSD будет выполняться только для короткого имени. По этому обновление DNS записей рекомендуется отключить (dyndns_update = false, dyndns_update_ptr = false).
*  Для введения хоста в домен в режиме с двумя именами предлагается использовать [временное решение в виде распространяемого не из пакета скрипта system-auth](https://git.altlinux.org/people/liannnix/packages/?p=alterator-auth.git;a=commit;h=31eef1e8a3d74d983ff9cf66af8a9a47578600d9).

Для использования длинного имени необходимо дополнительно указать короткое NetBIOS имя. 

Например:

	#./system-auth write ad domain.alt super-long-hostname sub --netbiosname=short-host

В случае с коротким именем хоста поведение скрипта не меняется.

**Для контроллеров домена длинные имена не допустимы.**

### На клиенте
Предварительно на клиенте должна быть настроена сеть.
В качестве первичного DNS должен быть указан такой DNS-сервер, который который умеет разрешать DNS-имена из домена AD.

В процессе привязки машины к домену происходит создание машинной учетной записи (или нахождение уже существующей, созданной заранее) и смена ее пароля.

При добавлении **Linux-машины** в домен создается файл krb5.keytab, который хранит ключи для аутентификации машины в домене через Kerberos (тот самый пароль учетной записи машины). Он необходим для того, чтобы машина могла аутентифицироваться и взаимодействовать с доменом.

Просмотреть содержимое файла krb5.keytab: 

	# klist -ket

Таким образом можно получить следующую информацию:

+ KVNO (Key Version Number) — номер версии ключа в системе аутентификации Kerberos. Когда ключ аутентификации учетной записи меняется (например, при ротации пароля), KVNO увеличивается. Это позволяет различать старые и новые версии ключей.
+ Timestamp - время создания записи для ключа в keytab-файле.
+ Principal - уникальный идентификатор объекта в Kerberos, для которого был сгенерирован ключ аутентификации. В krb5.keytab обычно хранятся Principal, которые используются для аутентификации машины или служб, работающих на ней. Они включают:
	* Машинный Principal (Представляет учетную запись компьютера в домене) - hostname$@REALM
	* Host Principal (Используется для базовых служб, связанных с машиной) - host/hostname.example.com@REALM
host/hostname@REALM
	* Service Principal (Представляет сетевые службы, которые используют Kerberos для аутентификации) - HTTP/webserver.example.com@REALM
ldap/server.example.com@REALM
	* Restricted Host Principal (Используется для служб с дополнительными ограничениями) - restrictedkrbhost/hostname.example.com@REALM
restrictedkrbhost/hostname@REALM

Также редактируется файл конфигурации krb5.conf, который определяет параметры для взаимодействия клиента с сервером Kerberos.

При добавлении **Windows-машины** в домен пароль учетной записи машины генерируется и хранится локально в базе Security Account Manager (SAM) в зашифрованном виде.

Файл SAM находится по пути: C:\Windows\System32\config\SAM

Он недоступен для прямого чтения, так как защищен системой. Пароль используется для вычисления ключа Kerberos, необходимого для аутентификации.

Однако машина все еще остается под управлением локального пользователя, который ее ввел в домен. Для того чтобы машина была полностью интегрирована и подчинялась доменным политикам, необходимо выполнение дополнительных шагов.

Чтобы ввести машину под управление домена необходим еще ряд действий:

+ Настройка локальной аутентификации  - для локальных и доменных пользователей. Эта настройка позволяет машине работать как с локальными учетными записями, так и с учетными записями из домена. 
+ Настройка разрешения имен  - позволяет машине правильно обрабатывать имена пользователей и групп из домена и обеспечивать доступ к ресурсам через корректную работу с именами.
+ ID-mapping - настройка, которая связывает UID/GID локальных пользователей с идентификаторами в домене (на  windows-машинах не требуется). 
+ Настройка ролей и привилегий - настройка управления доступом для пользователей домена на клиентских рабочих станциях.
+ Групповые политики - настройка рабочей среды.

Когда компьютер становится частью домена, он начинает подчиняться доменным политикам и может быть полностью интегрирован с другими доменными компьютерами, используя все ресурсы и возможности управления из централизованной системы.

Когда компьютер становится частью домена, он подчиняется доменным политикам и интегрируется с другими компьютерами в домене. Это позволяет использовать возможности централизованного управления учетными записями, доступом и настройками безопасности. Привязка машины к домену также упрощает аутентификацию доменных пользователей, позволяя им входить в систему с одной учетной записью и получать доступ ко всем ресурсам (Single Sign-On (SSO).

### Вход в домен AD клиентом на ALT Linux
В семействе дистрибутивов ALT рекомендуемым способом ввода машины в домен является использование модуля	аутентификации alterator-auth, который использует команду net ads join.

Модуль можно использовать в ACC (Центр управления системой) и в командной строке.

	# system-auth write ad domain.alt host-15 domain 'administrator' 'Pa$$word' [--windows2003] [--createcomputer="COMPUTEROU/SubCOMPUTEROU/SubSubCOMPUTEROU"] [--winbind] [--gpo] [-d]
	Joined 'HOST-15' to dns domain 'domain.alt'

Перед вводом машины в домен с помощью команды net ads join, происходит подготовка машины:
+ Настройка Avahi-daemon - настройка порядка поиска имен хостов в файле nsswitch.conf, если используется домен с суффиксом .local. В таком случае поиск через DNS должен быть раньше поиска через  mDNS (Multicast DNS).
+ Проверка DNS (проверка доступности Kerberos-сервера для указанного домена) (host -t SRV _kerberos._tcp.domain.alt | grep 'SRV record')
+ Редактирование системных конфигураций 
	+ настройки kerberos  в файле /etc/krb5.conf (kerberos-имя домена  default_realm = DOM.LOC, отключение поиска kerberos-имени домена через DNS:  dns_lookup_realm = false, Включение поиска kerberos-настроек домена через DNS:  dns_lookup_kdc = true)
	+ настройка службы winbind в файле /etc/samba/smb.conf (winbind запущен в любом случае)
	+ настройка  SSSD (/etc/sssd/sssd.conf
	+ настройка аутентификации (Для изменения настроек аутентификации (параметров PAM) в ALT Linux используется утилита control: # control system-auth sss)
	+ 	настройка  авторизации (Авторизационные NSS-базы GLibc настраиваются в файле /etc/nsswitch.conf.)
	+ Настройка ролей и привилегий - использование модуля libnss-role (control libnss-role enabled)
	+ включение групповых политик - настройка работы утилиты gpupdate
	+ настройка менеджера дисплея LightDM (в файле /etc/lightdm/lightdm.conf)
+ Синхронизация времени с контроллером домена. (Через net time, По протоколу RFC 867,  Через Центр управления системой → Дата и время, Через ntpdate)

Далее net ads join выполняет следующие действия:

+ Аутентификация с использованием Kerberos: Машина использует Kerberos для аутентификации на контроллере домена, используя учетные данные пользователя,имеющего на это права. 
+ Создание или нахождение уже имеющейся учетной записи машины в AD: Контроллер домена создает объект компьютера в Active Directory или находит заранее созданный. Этот объект связан с учетной записью машины и паролем доверия. Пароль учетной записи машины генерируется и сохраняется в локальном файле krb5.keytab.
+ Регистрация в DNS: Машина регистрирует свои записи в DNS, чтобы быть доступной для других устройств.
### Способы ввода машины в домен
Ввод машины в домен можно выполнить различными способами в зависимости от того, кто выполняет операцию, а также от того, какие права у пользователя. 

#### Администратор домена 
Администратор имеет право вводить машины в домен, а также повторно вводить машину в домен независимо от того, кто является владельцем учётной записи машины.

**Центр управления системой**

На клиенте необходимо открыть **Центр управления системой - Пользователи - Аутентификация**.  Выбрать необходимый вариант, заполнить поля и нажать **Применить**. Далее потребуется ввести данные администратора домена.

**Командная строка**

Использование аутентификации в Active Directory (используя кэш kerberos по умолчанию без пароля администратора)

	# system-auth write ad domain.name host workgroup [Administrator password] [--windows 2003] [--create computer=COMPUTER OU/Linux] [--winbind] [--gpo]

* --windows 2003 - Указывает, что подключение производится к домену на основе Windows Server 2003. Это может потребоваться для включения совместимости с устаревшими версиями AD.
* --create computer=COMPUTER OU/Linux - Указывает организационную единицу (OU), в которую будет помещена учетная запись компьютера.
	- COMPUTER — Имя создаваемой записи компьютера в домене.
	- OU/Linux — Путь к организационной единице в AD, где будет создана эта запись. Например: OU=LinuxComputers,DC=example,DC=com.
Если ключ не указан, учетная запись компьютера будет помещена в стандартный контейнер Computers.
* --winbind - Указывает использовать службу Winbind для взаимодействия с Active Directory.
* --gpo - Активирует поддержку групповых политик (GPO) на клиентской машине. 

#### Пользователь, принадлежащий группе с правами Администратора
Пользователи, принадлежащие группе Domain Admins и любой другой группе с необходимыми правами, имеют права на добавление и удаление машин из домена, но их доступ зависит от конфигурации политики безопасности и прав, установленных администратором домена.

Пользователь с правами Domain Admin может добавить машину в домен как через графический интерфейс (ЦУС), так и с помощью командной строки.
#### Передача пользователю прав на конкретную машину
При необходимости можно дать пользователю права для управления конкретным компьютером. Это позволяет предоставить доступ к выполнению задач, таких как сброс пароля машины, добавление её в домен или другие административные действия, без предоставления полномочий на весь домен.

В таком случае необходимо предварительно на контроллере домена создать учетную запись машины и использовать ее при присоединении машины к домену.

#### Автономное присоединение машины к домену

Это процесс, при котором машина подключается к домену без активного сетевого соединения с контроллером домена. Этот метод может быть полезен в случаях, когда машина находится в удаленном месте или временно не может подключиться к сети, но при этом необходимо подключить ее к домену.

### Повторный ввод машины в домен с именем уже существующей учётной записи машины

Если по каким то причинам необходимо ввести машину в домен с именем уже существующей учётной записи машины, то первая машина с таким же именем теряет связь с доменом.

Повторно использовать  имя уже существующей учётной записи рабочей станции в домене могут:
+ Администратор домена независимо от того, кто является владельцем учётной записи машины.
+ Пользователь с делегированными правами на имеющуюся в домене учётную запись машины (с правами на запись и сброс пароля).

> Машина также считается повторно введенной в домен, если она привязывается к учетной записи, которая была предварительно создана на контроллере домена.

## Вывод машины из домена 
Вывод машины из домена — это процесс удаления компьютера из управления доменом Active Directory, который включает несколько этапов как на стороне клиента, так и на стороне контроллера домена. Этот процесс позволяет вернуть машину в состояние локального управления.

Удалить машинную учетную запись можно несколькими способами:
+ на контроллере домена с помощью samba-tool computer delete MACHINE$ - при таком способе DNS-запись машины удаляется
+ на контроллере домена с помощью ADMC - DNS-запись машины не удаляется
+ На клиенте с помощью net ads leave -U administrator - DNS-запись машины не удаляется

В случаях, когда DNS-запись не удаляется, необходимо удалить ее самостоятельно:

	 samba-tool dns delete <DNS-сервер> <зона> <имя-записи> <тип-записи> <данные>

* <DNS-сервер> — адрес или имя DNS-сервера (например, 10.64.224.104 или dc.domain.alt)
* <зона> — имя зоны (например, domain.alt)
* <имя-записи> — имя удаляемой записи
* <тип-записи> — тип удаляемой записи (например, A, CNAME, TXT и т. д.)
* <данные> — значение записи (например, IP-адрес для A-записи)

На клиенте необходимо поменять способ аутентификации на локальную базу пользователей и поставить галочку для восстановления файлов конфигурации по умолчанию (smb.conf, krb5.conf, sssd.conf).
Также нужно удалить файл krb5.keytab, поменять hostname и очистить кэш sssd и winbind. 

## Диагностика
Проверить локальные настройки системы и параметры службы каталогов для успешной работы клиента в составе домена можно с помощью diag-domain-client.

Или самостоятельно:
+ Проверить, соответствует ли постоянное (статическое) имя хоста текущему (временному) имени хоста. ( статическое имя хоста: $ hostnamectl --static; временное имя хоста: $ hostname)
+ Проверить  является ли имя компьютера полностью определенным именем домена (FQDN).
+ Проверить метод аутентификации пользователей, используемого в подсистеме PAM (# /usr/sbin/control system-auth; # readlink -f /etc/pam.d/system-auth; # cat /etc/pam.d/system-auth)(подходит ли метод аутентификации для работы хоста в домене (допустимые значения: sss и winbind).)
+ Проверить применяемые в процессе PAM-аутентификации политики (#/usr/sbin/control system-policy; #readlink -f /etc/pam.d/system-policy; #cat /etc/pam.d/system-policy) 

## Ссылки
1. [Повторный ввод машины в домен с уже существующей учётной записью в домене](https://www.altlinux.org/ActiveDirectory/Join/Rejoin) 
2. 